<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Obowiązki domowe — Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --panel-w:320px;
  --tab-w:42px;
  --accent:#1f8f62;
  --accent-contrast:#fff;
  --bg:#f3f6f8;
  --card:#ffffff;
  --muted:#6b7280;
  --danger:#d93b3b;
  --glass: rgba(255,255,255,0.7);
  --radius:12px;
  --shadow: 0 12px 30px rgba(2,6,23,0.07);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f1720; -webkit-font-smoothing:antialiased}
header{background:var(--accent);color:var(--accent-contrast);padding:16px 18px;text-align:center;box-shadow:var(--shadow)}
h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:20px auto;padding:12px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:14px}

/* LOGIN modal */
#loginModal{
  position:fixed;left:50%;top:48%;transform:translate(-50%,-50%);
  width:480px;max-width:96%;background:var(--card);padding:20px;border-radius:14px;box-shadow:0 30px 80px rgba(2,6,23,0.18);z-index:4000;
}
#loginModal h2{margin:0 0 8px}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;margin:6px 0}
.btn{background:var(--accent);color:var(--accent-contrast);border:none;padding:9px 12px;border-radius:10px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #e6e9ee;color:var(--muted)}
.small{padding:6px 8px;font-size:13px;border-radius:8px}

/* Panels */
.sidePanel{
  position:fixed;top:0;height:100vh;width:var(--panel-w);background:linear-gradient(180deg,#ffffff,#fbfdfe);box-shadow:0 30px 60px rgba(2,6,23,0.08);
  transition:transform .34s cubic-bezier(.2,.8,.2,1);padding:16px;z-index:2000;overflow:auto;border-left:1px solid rgba(0,0,0,0.03)
}
#leftPanel{left:0;transform:translateX(calc(-100% + var(--tab-w)));border-right:1px solid rgba(0,0,0,0.04)}
#rightPanel{right:0;transform:translateX(calc(100% - var(--tab-w)));border-left:1px solid rgba(0,0,0,0.04)}
.panelTab{
  position:fixed;top:84px;width:var(--tab-w);height:var(--tab-w);display:flex;align-items:center;justify-content:center;background:var(--accent);color:white;border-radius:10px;cursor:pointer;z-index:2100;box-shadow:0 10px 26px rgba(2,6,23,0.12)
}
#leftTab{left:8px;border-radius:0 10px 10px 0}
#rightTab{right:8px;border-radius:10px 0 0 10px}
.sidePanel.open-left{transform:translateX(0) !important}
.sidePanel.open-right{transform:translateX(0) !important}

/* top toolbar */
.toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.userInfo{display:flex;gap:10px;align-items:center}
.badge{background:#eef9f0;color:var(--accent);padding:6px 10px;border-radius:8px;font-weight:600}

/* forms and table */
.inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.formRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.tableWrap{overflow:auto}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
th{background:var(--accent);color:#fff;position:sticky;top:0}
tr:nth-child(even){background:#fbfdfb}
tr:hover{background:#f0fff4}

/* small helpers */
.muted{color:var(--muted)}
.hint{font-size:13px;color:var(--muted)}
.center{display:flex;justify-content:center;align-items:center}
.sep{height:1px;background:rgba(0,0,0,0.04);margin:12px 0;border-radius:2px}

/* responsive */
@media (max-width:900px){
  :root{--panel-w:260px}
  .toolbar{flex-direction:column;align-items:flex-start}
  #loginModal{width:92%}
}
</style>
</head>
<body>

<header><h1>Obowiązki domowe — Multi-list</h1></header>

<!-- LOGIN modal -->
<div id="loginModal" role="dialog" aria-modal="true">
  <h2>Witaj — zaloguj się lub zarejestruj</h2>
  <div class="formRow">
    <input id="nick" class="input" placeholder="Nick (bez spacji)">
    <input id="password" class="input" type="password" placeholder="Hasło (min 6 znaków)">
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
    <button id="registerBtn" class="btn ghost small">Zarejestruj</button>
    <button id="loginBtn" class="btn small">Zaloguj</button>
  </div>
  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
    <div class="hint">Logowanie po nicku (nie używamy maili). Hasła są hash'owane w przeglądarce.</div>
    <div id="loginMsg" class="muted"></div>
  </div>
</div>

<!-- left panel: filters + admin -->
<div id="leftPanel" class="sidePanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Filtry & Panel Admina</h3>
    <button id="leftClose" class="btn small">✕</button>
  </div>

  <div class="sep"></div>

  <div>
    <h4>Filtry</h4>
    <div style="display:flex;flex-direction:column;gap:8px">
      <label>Data: <input id="filterDate" type="date" class="input"></label>
      <label>Użytkownik (nick): <input id="filterUser" class="input" placeholder="nick"></label>
      <label>Obowiązek: <select id="filterDuty" class="input"><option value="">Wszystkie</option></select></label>
      <div style="display:flex;gap:8px">
        <button id="btnFilter" class="btn small">Filtruj</button>
        <button id="btnReset" class="btn small ghost">Reset</button>
      </div>
    </div>
  </div>

  <div class="sep"></div>

  <div id="adminArea" class="admin-only">
    <h4>Panel Admina</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnExportCSV" class="btn small">Eksportuj CSV</button>
      <button id="btnClearAll" class="btn small" style="background:var(--danger)">Usuń wszystkie</button>
    </div>

    <div style="margin-top:10px">
      <h5>Globalne obowiązki (select)</h5>
      <div style="display:flex;gap:8px">
        <input id="newDuty" class="input" placeholder="Nowy obowiązek">
        <button id="addDuty" class="btn small">Dodaj</button>
      </div>
      <div id="dutiesList" style="margin-top:8px;font-size:14px"></div>
    </div>

    <div style="margin-top:12px">
      <h5>Zarządzanie użytkownikami</h5>
      <div id="usersAdmin" style="font-size:14px"></div>
    </div>

    <div style="margin-top:12px">
      <h5>Wygląd</h5>
      <label>Motyw:
        <select id="themeMode" class="input">
          <option value="light">Jasny</option><option value="dark">Ciemny</option>
        </select>
      </label>
      <label>Kolor akcentu: <input id="cfgAccent" type="color" value="#1f8f62"></label>
      <label>Czcionka:
        <select id="cfgFont" class="input">
          <option value="Inter, system-ui, Arial, sans-serif">System</option>
          <option value="Verdana, Geneva, sans-serif">Verdana</option>
          <option value="Tahoma, Geneva, sans-serif">Tahoma</option>
        </select>
      </label>
      <div style="margin-top:6px;display:flex;gap:8px">
        <button id="applyStyle" class="btn small">Zastosuj</button>
        <button id="saveStyle" class="btn small ghost">Zapisz</button>
      </div>
    </div>
  </div>
</div>
<div id="leftTab" class="panelTab" title="Filtry / Admin">≡</div>

<!-- right panel: lists and list meta -->
<div id="rightPanel" class="sidePanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Listy</h3>
    <button id="rightClose" class="btn small">✕</button>
  </div>

  <div class="sep"></div>

  <div>
    <label>Wybierz listę:
      <select id="listsSelect" class="input"></select>
    </label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="refreshLists" class="btn small">Odśwież</button>
      <button id="openCreate" class="btn small ghost">Utwórz</button>
    </div>

    <div id="createArea" style="margin-top:12px;display:none">
      <h4>Utwórz / Edytuj listę</h4>
      <label>Nazwa: <input id="listName" class="input"></label>
      <label>Nagłówki (oddziel '|' ) : <input id="listCols" class="input" placeholder="Zakupy|Ile|Zrobione"></label>
      <label><input id="listHasDate" type="checkbox"> Ma datę</label>
      <label><input id="listHasCheckbox" type="checkbox"> Ma checkbox (np. Zrobione)</label>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="createListBtn" class="btn">Zapisz</button>
        <button id="cancelCreate" class="btn ghost">Anuluj</button>
      </div>
    </div>

    <div id="listsInfo" style="margin-top:12px;font-size:14px"></div>
  </div>
</div>
<div id="rightTab" class="panelTab" title="Listy">⚙</div>

<!-- MAIN APP -->
<main class="container" id="app" style="display:none">
  <div class="card toolbar">
    <div style="display:flex;gap:12px;align-items:center">
      <div><strong>Aktywna lista:</strong> <span id="activeListName" class="muted">—</span></div>
      <div id="roleBadge" class="badge" style="display:none"></div>
    </div>
    <div class="userInfo">
      <div class="muted">Zalogowany: <strong id="whoami">—</strong></div>
      <div style="display:flex;gap:8px">
        <button id="logout" class="btn small">Wyloguj</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Dodaj wpis</h3>
    <form id="addForm" class="inline">
      <div id="dynamicFields" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>
      <button type="submit" class="btn">Dodaj wpis</button>
    </form>
    <div id="formMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>Wpisy</h3>
    <div class="tableWrap">
      <table id="tasksTable">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Firebase (compat, single-file friendly) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ================= CONFIG: Firebase (user-provided values) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDeH4Ouu8XU09atWJMsawPrEsUCDTd8Pzo",
  authDomain: "obowiazki-domowe-b2312.firebaseapp.com",
  databaseURL: "https://obowiazki-domowe-b2312-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "obowiazki-domowe-b2312",
  storageBucket: "obowiazki-domowe-b2312.firebasestorage.app",
  messagingSenderId: "348397631566",
  appId: "1:348397631566:web:fef9f724dbf737b8cf6b1f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const usersRef = db.ref('users');     // users/{username} => { passwordHash, displayName, role, disabled }
const listsRef = db.ref('lists');     // lists/{listId}/meta and /tasks
const dutiesRef = db.ref('duties');   // duties/global and duties/{listId}

/* ================ Utilities ================ */
// SHA-256 hash (hex)
async function sha256Hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}
const q = s => document.querySelector(s);

/* ================ UI refs ================ */
const loginModal = q('#loginModal'), nickEl = q('#nick'), passEl = q('#password');
const loginMsg = q('#loginMsg'), btnLogin = q('#loginBtn'), btnRegister = q('#registerBtn');

const leftPanel = q('#leftPanel'), rightPanel = q('#rightPanel'), leftTab = q('#leftTab'), rightTab = q('#rightTab');
const leftClose = q('#leftClose'), rightClose = q('#rightClose');

const adminArea = q('#adminArea'), usersAdmin = q('#usersAdmin'), dutiesList = q('#dutiesList');
const newDuty = q('#newDuty'), addDutyBtn = q('#addDuty');

const filterDuty = q('#filterDuty'), btnFilter = q('#btnFilter'), btnReset = q('#btnReset'), filterDate = q('#filterDate'), filterUser = q('#filterUser');

const listsSelect = q('#listsSelect'), refreshLists = q('#refreshLists');
const createArea = q('#createArea'), openCreate = q('#openCreate'), cancelCreate = q('#cancelCreate');
const listName = q('#listName'), listCols = q('#listCols'), listHasDate = q('#listHasDate'), listHasCheckbox = q('#listHasCheckbox');
const createListBtn = q('#createListBtn'), listsInfo = q('#listsInfo');

const app = q('#app'), whoami = q('#whoami'), roleBadge = q('#roleBadge'), logoutBtn = q('#logout');
const activeListName = q('#activeListName');

const dynamicFields = q('#dynamicFields'), addForm = q('#addForm'), formMsg = q('#formMsg');
const theadRow = q('#theadRow'), tbody = q('#tbody');

const btnExportCSV = q('#btnExportCSV'), btnClearAll = q('#btnClearAll');
const cfgAccent = q('#cfgAccent'), cfgFont = q('#cfgFont'), themeMode = q('#themeMode'), applyStyleBtn = q('#applyStyle'), saveStyleBtn = q('#saveStyle');

/* ================ State ================ */
let currentUser = null; // { username, displayName, role, disabled }
let currentListId = null;
let currentListMeta = null;
let tasksListener = null;
let prevListId = null;

/* ================ Panel behavior ================ */
let leftOpen = false, rightOpen = false;
function toggleLeft(v){
  leftOpen = (typeof v === 'boolean') ? v : !leftOpen;
  if(leftOpen){ leftPanel.classList.add('open-left'); leftTab.style.transform = `translateX(var(--panel-w))`; }
  else { leftPanel.classList.remove('open-left'); leftTab.style.transform = 'translateX(0)'; }
}
function toggleRight(v){
  rightOpen = (typeof v === 'boolean') ? v : !rightOpen;
  if(rightOpen){ rightPanel.classList.add('open-right'); rightTab.style.transform = `translateX(calc(-1 * var(--panel-w)))`; }
  else { rightPanel.classList.remove('open-right'); rightTab.style.transform = 'translateX(0)'; }
}
leftTab.addEventListener('click', ()=> toggleLeft());
rightTab.addEventListener('click', ()=> toggleRight());
leftClose.addEventListener('click', ()=> toggleLeft(false));
rightClose.addEventListener('click', ()=> toggleRight(false));

/* ================ Authentication (username + password hash) ================ */
btnRegister.addEventListener('click', async ()=>{
  const username = nickEl.value.trim();
  const pass = passEl.value;
  if(!username || username.includes(' ') || !pass || pass.length < 6){ loginMsg.textContent = 'Nick bez spacji i hasło min 6 znaków'; return; }
  const snap = await usersRef.child(username).get();
  if(snap.exists()){ loginMsg.textContent = 'Nick zajęty'; return; }
  const hash = await sha256Hex(pass);
  await usersRef.child(username).set({ displayName: username, passwordHash: hash, role: 'user', disabled: false, createdAt: Date.now() });
  loginMsg.style.color='green'; loginMsg.textContent = 'Zarejestrowano. Zaloguj się.';
  passEl.value='';
});

btnLogin.addEventListener('click', async ()=>{
  const username = nickEl.value.trim();
  const pass = passEl.value;
  if(!username || !pass){ loginMsg.textContent = 'Podaj nick i hasło'; return; }
  const snap = await usersRef.child(username).get();
  if(!snap.exists()){ loginMsg.textContent = 'Nie ma takiego użytkownika'; return; }
  const data = snap.val();
  if(data.disabled){ loginMsg.textContent = 'Konto zablokowane'; return; }
  const hash = await sha256Hex(pass);
  if(hash !== data.passwordHash){ loginMsg.textContent = 'Błędne hasło'; return; }
  currentUser = { username, displayName: data.displayName || username, role: data.role || 'user', disabled: !!data.disabled };
  onLogin();
});

/* create default admin in RTDB if missing */
(async function ensureAdmin(){
  try{
    const snap = await usersRef.child('admin').get();
    if(!snap.exists()){
      const hash = await sha256Hex('admin123');
      await usersRef.child('admin').set({ displayName:'admin', passwordHash:hash, role:'admin', disabled:false, createdAt: Date.now() });
      console.log('Default admin created (admin/admin123)');
    }
  }catch(e){ console.warn('ensureAdmin error', e); }
})();

/* after login */
async function onLogin(){
  document.getElementById('loginModal').style.display='none';
  app.style.display='block';
  whoami.textContent = currentUser.displayName || currentUser.username;
  roleBadge.style.display = 'inline-block'; roleBadge.textContent = currentUser.role;
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = (currentUser.role === 'admin') ? '' : 'none');
  await loadLists();
  await loadDutiesAll();
  renderUsersAdmin();
  applySavedStyle();
}

/* logout */
logoutBtn.addEventListener('click', ()=>{
  currentUser = null; currentListId = null; currentListMeta = null;
  app.style.display='none'; document.getElementById('loginModal').style.display='block';
  nickEl.value=''; passEl.value='';
});

/* ================ Lists & Duties ================ */
async function loadLists(){
  const snap = await listsRef.get();
  listsSelect.innerHTML = '';
  if(!snap.exists()){
    const meta = { name:'Obowiązki domowe', cols:['Co zrobił','Imię'], hasDate:true, hasCheckbox:false };
    await listsRef.child('main/meta').set(meta);
    await dutiesRef.child('main').set(['Odkurzanie','Zmywarka','Zwierzaki']);
  }
  const s2 = await listsRef.get();
  s2.forEach(ch => {
    const meta = ch.val().meta || ch.val();
    const opt = document.createElement('option'); opt.value = ch.key; opt.textContent = meta.name || ch.key;
    listsSelect.appendChild(opt);
  });
  if(!currentListId){
    const first = listsSelect.options[0];
    if(first){ currentListId = first.value; listsSelect.value = first.value; }
  } else {
    try{ listsSelect.value = currentListId; }catch(e){}
  }
  await onListChange();
}
listsSelect.addEventListener('change', ()=> { currentListId = listsSelect.value; onListChange(); });
refreshLists.addEventListener('click', ()=> loadLists());

async function createOrUpdateList(metaObj){
  if(!currentUser || currentUser.role!=='admin') return alert('Tylko admin');
  if(!currentListId){
    const ref = await listsRef.push({ meta: metaObj });
    currentListId = ref.key;
  } else {
    await listsRef.child(currentListId + '/meta').set(metaObj);
  }
  await loadLists();
}

openCreate.addEventListener('click', ()=> createArea.style.display = 'block');
cancelCreate.addEventListener('click', ()=> createArea.style.display = 'none');
createListBtn.addEventListener('click', async ()=>{
  if(!currentUser || currentUser.role !== 'admin'){ alert('Tylko admin'); return; }
  const name = listName.value.trim(); if(!name){ alert('Nazwa listy'); return; }
  const cols = listCols.value ? listCols.value.split('|').map(s=>s.trim()).filter(Boolean) : ['Opis'];
  const meta = { name, cols, hasDate: !!listHasDate.checked, hasCheckbox: !!listHasCheckbox.checked };
  const newRef = await listsRef.push({ meta });
  await dutiesRef.child(newRef.key).set([]);
  listName.value=''; listCols.value=''; listHasDate.checked=false; listHasCheckbox.checked=false;
  createArea.style.display='none';
  await loadLists();
});

/* render lists info */
async function renderListsInfo(){
  listsInfo.innerHTML = '';
  const snap = await listsRef.get();
  snap.forEach(ch=>{
    const meta = ch.val().meta || ch.val();
    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.margin='6px 0';
    div.innerHTML = `<div><strong>${meta.name || '—'}</strong> <small class="muted">${ch.key}</small></div>`;
    listsInfo.appendChild(div);
  });
}

/* ===== load duties (global + list-specific) ===== */
async function loadDutiesAll(){
  const set = new Set();
  const gSnap = await dutiesRef.child('global').get();
  if(gSnap.exists()) gSnap.forEach(c=> set.add(c.val()));
  if(currentListId){
    const lSnap = await dutiesRef.child(currentListId).get();
    if(lSnap.exists()) lSnap.forEach(c => set.add(c.val()));
  }
  renderDutiesSelect(Array.from(set));
  renderDutiesAdmin(); // update admin list
}

/* fill filter and dynamic select */
function renderDutiesSelect(arr){
  filterDuty.innerHTML = '<option value="">Wszystkie</option>';
  arr.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; filterDuty.appendChild(o); });
}

/* admin duties UI */
async function renderDutiesAdmin(){
  dutiesList.innerHTML = '';
  const snap = await dutiesRef.child('global').get();
  if(!snap.exists()){ dutiesList.textContent = 'Brak'; return; }
  snap.forEach(ch=>{
    const v = ch.val();
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='6px 0';
    const left = document.createElement('div'); left.textContent = v;
    const right = document.createElement('div');
    const del = document.createElement('button'); del.className='btn small ghost'; del.textContent='Usuń';
    del.onclick = async ()=>{ if(confirm('Usuń obowiązek?')){ await dutiesRef.child('global/' + ch.key).remove(); await loadDutiesAll(); } };
    right.appendChild(del); row.appendChild(left); row.appendChild(right); dutiesList.appendChild(row);
  });
}
addDutyBtn.addEventListener('click', async ()=>{
  if(!currentUser || currentUser.role!=='admin') return alert('Tylko admin');
  const v = newDuty.value.trim(); if(!v) return;
  await dutiesRef.child('global').push(v);
  newDuty.value='';
  await loadDutiesAll();
});

/* ======== On list change: load meta, dynamic form, table header, tasks listener ======== */
async function onListChange(){
  if(!currentListId) return;
  const metaSnap = await listsRef.child(currentListId + '/meta').get();
  currentListMeta = metaSnap.exists() ? metaSnap.val() : { name: listsSelect.options[listsSelect.selectedIndex].text, cols:['Opis'], hasDate:false, hasCheckbox:false };
  activeListName.textContent = currentListMeta.name || currentListId;
  buildDynamicForm();
  buildTableHeader();
  attachTasksListener();
  renderListsInfo();
  await loadDutiesAll();
}

/* build dynamic add form */
function buildDynamicForm(){
  dynamicFields.innerHTML = '';
  if(!currentListMeta) return;
  if(currentListMeta.hasDate){
    const d = document.createElement('input'); d.type='date'; d.id='field_date'; d.className='input'; dynamicFields.appendChild(d);
  }
  const sel = document.createElement('select'); sel.id='taskType'; sel.className='input';
  const empty = document.createElement('option'); empty.value=''; empty.disabled=true; empty.selected=true; empty.textContent='Wybierz obowiązek';
  sel.appendChild(empty);
  // populate duties later by loadDutiesAll -> buildDynamicForm called after duties loaded
  dynamicFields.appendChild(sel);
  currentListMeta.cols.forEach(col=>{
    if(/imię|użytkownik|user/i.test(col)) return;
    if(currentListMeta.hasCheckbox && /zrobi|zrobione|done/i.test(col.toLowerCase())){
      const label = document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id='field_checkbox';
      label.appendChild(cb); label.appendChild(document.createTextNode(col)); dynamicFields.appendChild(label);
    } else {
      const inp = document.createElement('input'); inp.type='text'; inp.className='input'; inp.placeholder = col; inp.dataset.col = col;
      dynamicFields.appendChild(inp);
    }
  });
}

/* fill duty select options after duties loaded */
async function fillDutySelects(){
  const arr = [];
  const g = await dutiesRef.child('global').get();
  if(g.exists()) g.forEach(ch=> arr.push(ch.val()));
  const l = await dutiesRef.child(currentListId).get();
  if(l.exists()) l.forEach(ch=> arr.push(ch.val()));
  const unique = Array.from(new Set(arr));
  const sel = document.getElementById('taskType');
  if(sel){
    // remove old options except first placeholder
    sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
    unique.forEach(d=> { const o = document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o); });
  }
  // also update filter select
  renderDutiesSelect(unique);
}

/* build table header based on meta */
function buildTableHeader(){
  theadRow.innerHTML = '';
  if(!currentListMeta) return;
  if(currentListMeta.hasDate) theadRow.appendChild(createTH('Data'));
  currentListMeta.cols.forEach(c => {
    if(/imię|użytkownik|user/i.test(c)) theadRow.appendChild(createTH('Użytkownik'));
    else theadRow.appendChild(createTH(c));
  });
  if(currentListMeta.hasCheckbox) theadRow.appendChild(createTH('Zrobione'));
  if(currentUser && currentUser.role==='admin') theadRow.appendChild(createTH('Akcje'));
}
function createTH(t){ const th = document.createElement('th'); th.textContent = t; return th; }

/* attach tasks listener */
let currentListener = null;
function attachTasksListener(){
  if(currentListener && prevListId) listsRef.child(prevListId + '/tasks').off('value', currentListener);
  prevListId = currentListId;
  currentListener = listsRef.child(currentListId + '/tasks').on('value', snap => {
    tbody.innerHTML = '';
    snap.forEach(ch => {
      const d = ch.val();
      const tr = document.createElement('tr');
      if(currentListMeta.hasDate) tr.appendChild(td(d.date || ''));
      currentListMeta.cols.forEach(col => {
        if(/imię|użytkownik|user/i.test(col)) tr.appendChild(td(d.authorName || d.author || ''));
        else tr.appendChild(td(d[col] || ''));
      });
      if(currentListMeta.hasCheckbox){
        const tdcb = document.createElement('td'); const cb = document.createElement('input'); cb.type='checkbox'; cb.disabled=true; cb.checked=!!d.checkbox; tdcb.appendChild(cb); tr.appendChild(tdcb);
      }
      if(currentUser && currentUser.role==='admin'){
        const act = document.createElement('td'); const del = document.createElement('button'); del.className='btn small'; del.textContent='Usuń';
        del.onclick = ()=> { if(confirm('Usuń wpis?')) listsRef.child(currentListId + '/tasks/' + ch.key).remove(); };
        act.appendChild(del); tr.appendChild(act);
      } else tr.appendChild(td(''));
      tbody.appendChild(tr);
    });
    // fill duty selects now that we have tasks (to include list-specific duties)
    fillDutySelects();
  });
}
function td(t){ const el=document.createElement('td'); el.textContent = t; return el; }

/* add task form */
addForm.addEventListener('submit', async (e)=> {
  e.preventDefault();
  if(!currentListId) return alert('Wybierz listę po prawej');
  if(!currentUser) return alert('Zaloguj się');
  const payload = {};
  if(currentListMeta.hasDate){
    const dateEl = document.getElementById('field_date'); payload.date = dateEl ? dateEl.value : '';
  }
  const duty = document.getElementById('taskType'); if(!duty || !duty.value){ formMsg.textContent = 'Wybierz obowiązek'; return; }
  payload.task = duty.value;
  currentListMeta.cols.forEach(col => {
    if(/imię|użytkownik|user/i.test(col)) return;
    const inp = dynamicFields.querySelector(`input[data-col="${col}"]`);
    if(inp) payload[col] = inp.value || '';
  });
  if(currentListMeta.hasCheckbox){
    const cb = document.getElementById('field_checkbox'); payload.checkbox = !!(cb && cb.checked);
  }
  payload.author = currentUser.username;
  payload.authorName = currentUser.displayName || currentUser.username;
  await listsRef.child(currentListId + '/tasks').push(payload);
  formMsg.textContent = 'Dodano';
  setTimeout(()=> formMsg.textContent = '', 1200);
  dynamicFields.querySelectorAll('input[type="text"]').forEach(i=> i.value='');
  dynamicFields.querySelectorAll('input[type="checkbox"]').forEach(i=> i.checked=false);
});

/* filters */
btnFilter.addEventListener('click', async ()=>{
  if(!currentListId) return;
  const dateF = filterDate.value;
  const userF = (filterUser.value || '').toLowerCase();
  const dutyF = (filterDuty.value || '').toLowerCase();
  const snap = await listsRef.child(currentListId + '/tasks').get();
  tbody.innerHTML = '';
  snap.forEach(ch => {
    const d = ch.val();
    let ok = true;
    if(dateF && d.date !== dateF) ok = false;
    if(userF && !((d.authorName||'').toLowerCase().includes(userF))) ok = false;
    if(dutyF && !((d.task||'').toLowerCase().includes(dutyF))) ok = false;
    if(ok){
      const tr = document.createElement('tr');
      if(currentListMeta.hasDate) tr.appendChild(td(d.date||''));
      currentListMeta.cols.forEach(col => {
        if(/imię|użytkownik|user/i.test(col)) tr.appendChild(td(d.authorName || ''));
        else tr.appendChild(td(d[col] || ''));
      });
      if(currentListMeta.hasCheckbox){ const tdcb=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.disabled=true; cb.checked=!!d.checkbox; tdcb.appendChild(cb); tr.appendChild(tdcb); }
      if(currentUser && currentUser.role==='admin'){ const act=document.createElement('td'); const del=document.createElement('button'); del.className='btn small'; del.textContent='Usuń'; del.onclick=()=>listsRef.child(currentListId + '/tasks/' + ch.key).remove(); act.appendChild(del); tr.appendChild(act); } else tr.appendChild(td(''));
      tbody.appendChild(tr);
    }
  });
});
btnReset.addEventListener('click', ()=>{ filterDate.value=''; filterUser.value=''; filterDuty.value=''; attachTasksListener(); });

/* ===== Admin: users management ===== */
async function renderUsersAdmin(){
  usersAdmin.innerHTML = '';
  if(!currentUser || currentUser.role!=='admin') return;
  const snap = await usersRef.get();
  snap.forEach(ch=>{
    const uname = ch.key; const u = ch.val();
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='6px 0';
    const left = document.createElement('div'); left.innerHTML = `<strong>${u.displayName || uname}</strong> <div class="muted">${uname}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
    const sel = document.createElement('select'); ['user','admin','viewer'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(u.role===r) o.selected=true; sel.appendChild(o); });
    sel.onchange = ()=> usersRef.child(uname).update({ role: sel.value });
    const block = document.createElement('button'); block.className='btn small'; block.textContent = u.disabled ? 'Odblokuj' : 'Zablokuj';
    block.onclick = ()=> usersRef.child(uname).update({ disabled: !u.disabled }).then(()=> renderUsersAdmin());
    const reset = document.createElement('button'); reset.className='btn small ghost'; reset.textContent='Reset hasła';
    reset.onclick = async ()=> { const np = prompt('Nowe hasło (min 6 znaków) dla ' + uname); if(np && np.length>=6){ const h = await sha256Hex(np); await usersRef.child(uname).update({ passwordHash: h }); alert('Hasło zresetowane'); } else alert('Hasło za krótkie');};
    const del = document.createElement('button'); del.className='btn small ghost'; del.textContent='Usuń';
    del.onclick = ()=> { if(confirm('Usunąć meta użytkownika?')) usersRef.child(uname).remove().then(()=> renderUsersAdmin());};
    right.appendChild(sel); right.appendChild(block); right.appendChild(reset); right.appendChild(del);
    row.appendChild(left); row.appendChild(right); usersAdmin.appendChild(row);
  });
}

/* ===== Export CSV & ClearAll (admin) ===== */
btnExportCSV.addEventListener('click', async ()=>{
  if(!currentListId) return alert('Wybierz listę');
  const snap = await listsRef.child(currentListId + '/tasks').get();
  const rows = [];
  const header = [];
  if(currentListMeta.hasDate) header.push('Data');
  header.push(...currentListMeta.cols);
  if(currentListMeta.hasCheckbox) header.push('Checkbox');
  header.push('Author');
  rows.push(header.join(','));
  snap.forEach(ch=>{
    const d = ch.val(); const row=[];
    if(currentListMeta.hasDate) row.push('"' + (d.date || '') + '"');
    currentListMeta.cols.forEach(c => row.push('"' + ((d[c]||'')+'').replace(/"/g,'""') + '"'));
    if(currentListMeta.hasCheckbox) row.push(d.checkbox ? 'TRUE' : 'FALSE');
    row.push('"' + (d.authorName || '') + '"');
    rows.push(row.join(','));
  });
  const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (currentListMeta.name || currentListId) + '.csv'; a.click();
  URL.revokeObjectURL(a.href);
});

btnClearAll.addEventListener('click', async ()=>{
  if(!currentListId) return alert('Wybierz listę');
  if(!confirm('Na pewno usunąć wszystkie wpisy z tej listy?')) return;
  await listsRef.child(currentListId + '/tasks').remove();
});

/* ======= Styling apply/save ======= */
applyStyleBtn.addEventListener('click', ()=> applyStyle(false));
saveStyleBtn.addEventListener('click', ()=> applyStyle(true));
function applyStyle(save){
  document.documentElement.style.setProperty('--accent', cfgAccent.value);
  document.body.style.fontFamily = cfgFont.value;
  if(themeMode.value === 'dark'){
    document.body.style.background = '#0b1220';
    document.body.style.color = '#e6eef3';
    document.querySelectorAll('.card').forEach(c=> c.style.background = '#071026');
  } else {
    document.body.style.background = 'var(--bg)';
    document.body.style.color = '#0f1720';
    document.querySelectorAll('.card').forEach(c=> c.style.background = 'var(--card)');
  }
  document.querySelector('header').style.background = cfgAccent.value;
  document.querySelectorAll('th').forEach(th => th.style.background = cfgAccent.value);
  if(save) localStorage.setItem('uiStyle', JSON.stringify({ accent: cfgAccent.value, font: cfgFont.value, mode: themeMode.value }));
}
function applySavedStyle(){
  const s = localStorage.getItem('uiStyle');
  if(!s) return;
  try{
    const o = JSON.parse(s);
    if(o.accent) cfgAccent.value=o.accent;
    if(o.font) cfgFont.value=o.font;
    if(o.mode) themeMode.value=o.mode;
    applyStyle(false);
  }catch(e){}
}

/* ======== initial boot (ensure main list & global duties) ======== */
(async function init(){
  applySavedStyle();
  // ensure main list exists
  const main = await listsRef.child('main/meta').get();
  if(!main.exists()){
    await listsRef.child('main/meta').set({ name:'Obowiązki domowe', cols:['Co zrobił','Imię'], hasDate:true, hasCheckbox:false });
    await dutiesRef.child('main').set(['Odkurzanie','Zmywarka','Zwierzaki']);
  }
  const g = await dutiesRef.child('global').get();
  if(!g.exists()){
    await dutiesRef.child('global').push('Odkurzanie'); await dutiesRef.child('global').push('Zmywarka'); await dutiesRef.child('global').push('Zwierzaki');
  }
  await loadLists();
})();

</script>
</body>
</html>