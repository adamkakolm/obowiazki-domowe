<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Obowiązki Domowe</title>
<style>
:root{
  --primary:#4CAF50;--background:#f4f6f9;
  --surface:#fff;--text:#333;--shadow:0 4px 12px rgba(0,0,0,0.08);
}
body.dark{--background:#1e1e1e;--surface:#2c2c2c;--text:#ddd;}
body{margin:0;font-family:Arial, sans-serif;background:var(--background);color:var(--text);}
.topbar{position:fixed;top:0;left:0;right:0;background:var(--primary);color:white;
  padding:12px;display:flex;justify-content:space-between;z-index:1000;}
.topbar button{margin-right:6px;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;}
.auth-box{width:320px;margin:10vh auto;padding:20px;background:var(--surface);
  border-radius:10px;box-shadow:var(--shadow);text-align:center;}
.auth-box input{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px;}
.sidebar,.rightbar{
  position:fixed;top:60px;bottom:0;width:260px;background:var(--surface);
  box-shadow:var(--shadow);padding:12px;overflow:auto;transition:transform 0.3s ease;
  z-index:999;
}
.sidebar{left:0;transform:translateX(-100%);}
.sidebar.open{transform:translateX(0);}
.rightbar{right:0;transform:translateX(100%);}
.rightbar.open{transform:translateX(0);}
.sidebar button,.rightbar button{width:100%;margin:6px 0;padding:8px;border:none;
  background:var(--primary);color:white;border-radius:6px;cursor:pointer;}
.layout{margin-top:70px;padding:20px;}
.main{max-width:1000px;margin:0 auto;background:var(--surface);
  padding:20px;border-radius:10px;box-shadow:var(--shadow);}
#entryForm{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
#entryForm input{padding:8px;border:1px solid #ccc;border-radius:6px;}
#entryForm button{padding:8px 12px;background:var(--primary);color:white;border:none;
  border-radius:6px;cursor:pointer;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;}
th{background:var(--primary);color:white;}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="login-screen">
  <div class="auth-box">
    <h2>🔑 Logowanie</h2>
    <input id="username" placeholder="Login">
    <input id="password" type="password" placeholder="Hasło">
    <button onclick="login()">Zaloguj</button>
    <p>Nie masz konta? <a href="#" onclick="showRegister()">Rejestracja</a></p>
  </div>
</div>
<!-- REGISTER -->
<div id="register-screen" style="display:none">
  <div class="auth-box">
    <h2>📝 Rejestracja</h2>
    <input id="reg-username" placeholder="Login">
    <input id="reg-password" type="password" placeholder="Hasło">
    <button onclick="register()">Zarejestruj</button>
    <p><a href="#" onclick="showLogin()">Masz konto? Zaloguj</a></p>
  </div>
</div>
<!-- APP -->
<div id="app" style="display:none">
  <div class="topbar">
    <div>
      <button onclick="toggleSidebar()">☰ Listy</button>
      <span id="userInfo"></span>
    </div>
    <div>
      <button onclick="toggleRightbar()">⚙️</button>
      <button onclick="toggleDarkMode()">🌓</button>
      <button onclick="logout()">🚪</button>
    </div>
  </div>
  <!-- Sidebars -->
  <div class="sidebar" id="sidebar">
    <h3>📋 Listy</h3>
    <div id="lists"></div>
  </div>
  <div class="rightbar" id="rightbar">
    <h3>⚙️ Ustawienia</h3>
    <div id="settings"></div>
    <div id="adminPanel" style="margin-top:20px;display:none;">
      <h3>👑 Panel Admina</h3>
      <div id="users"></div>
    </div>
  </div>
  <!-- Main -->
  <div class="layout">
    <div class="main">
      <h2 id="currentListTitle">Brak wybranej listy</h2>
      <form id="entryForm"></form>
      <table>
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyDeH4Ouu8XU09atWJMsawPrEsUCDTd8Pzo",
  authDomain:"obowiazki-domowe-b2312.firebaseapp.com",
  databaseURL:"https://obowiazki-domowe-b2312-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"obowiazki-domowe-b2312",
  storageBucket:"obowiazki-domowe-b2312.firebasestorage.app",
  messagingSenderId:"348397631566",
  appId:"1:348397631566:web:fef9f724dbf737b8cf6b1f"
});
const db=firebase.database();
let currentUser=null,currentList=null,listSettings={columns:["Obowiązek","Użytkownik"],withDate:true};

// --- Auth ---
function showRegister(){loginScr().style.display="none";regScr().style.display="block";}
function showLogin(){loginScr().style.display="block";regScr().style.display="none";}
function loginScr(){return document.getElementById("login-screen");}
function regScr(){return document.getElementById("register-screen");}
function login(){
  const u=username.value.trim(),p=password.value;
  db.ref("users/"+u).get().then(s=>{
    if(s.exists()&&s.val().password===p){currentUser={name:u,role:s.val().role};afterLogin();}
    else alert("Błędne dane logowania");
  });
}
function register(){
  const u=document.getElementById("reg-username").value.trim(),p=document.getElementById("reg-password").value;
  db.ref("users/"+u).set({password:p,role:"user"}).then(()=>{alert("Zarejestrowano!");showLogin();});
}
function logout(){document.getElementById("app").style.display="none";loginScr().style.display="block";}

// --- UI ---
function toggleDarkMode(){document.body.classList.toggle("dark");}
function toggleSidebar(){document.getElementById("sidebar").classList.toggle("open");}
function toggleRightbar(){document.getElementById("rightbar").classList.toggle("open");}
function afterLogin(){
  loginScr().style.display=regScr().style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("userInfo").innerText="👤 "+currentUser.name+" ("+currentUser.role+")";
  loadLists();
  if(currentUser.role==="admin"){
    document.getElementById("adminPanel").style.display="block";
    loadUsers();
  }
}

// --- Lists ---
function loadLists(){
  db.ref("lists").on("value",snap=>{
    const l=document.getElementById("lists");l.innerHTML="";
    snap.forEach(ch=>{
      const n=ch.key;
      const div=document.createElement("div");
      div.style.display="flex";div.style.alignItems="center";div.style.gap="4px";
      const btn=document.createElement("button");
      btn.innerText=n;
      btn.style.flex="1";
      btn.onclick=()=>switchList(n);
      div.appendChild(btn);
      if(currentUser.role==="admin"){
        const edit=document.createElement("button");
        edit.innerText="✏️"; edit.style.width="40px";
        edit.onclick=(e)=>{e.stopPropagation();renameList(n);};
        div.appendChild(edit);
      }
      l.appendChild(div);
    });
    if(currentUser.role==="admin"){
      const addBtn=document.createElement("button");
      addBtn.innerText="➕ Nowa lista";
      addBtn.onclick=newList;
      l.appendChild(addBtn);
    }
  });
}
function newList(){
  const name=prompt("Nazwa nowej listy:");
  if(!name)return;
  db.ref("lists/"+name+"/settings").set({columns:["Obowiązek","Użytkownik"],withDate:true});
}
function switchList(n){
  currentList=n;
  db.ref("lists/"+n+"/settings").get().then(s=>{
    if(s.exists()) listSettings=s.val();
    renderHead();renderForm();loadEntries();renderSettings();
    currentListTitle.innerText="Lista: "+n;
  });
}
function renameList(oldName){
  const newName=prompt("Nowa nazwa listy:", oldName);
  if(!newName||newName===oldName)return;
  db.ref("lists/"+oldName).get().then(s=>{
    if(s.exists()){
      db.ref("lists/"+newName).set(s.val()).then(()=>{
        db.ref("lists/"+oldName).remove();
        switchList(newName);
      });
    }
  });
}
function renderSettings(){
  const s=document.getElementById("settings");s.innerHTML="";
  if(currentUser.role!=="admin"){
    s.innerHTML="<p>Brak uprawnień do edycji ustawień.</p>";
    return;
  }
  listSettings.columns.forEach((c,i)=>{
    s.innerHTML+=`<div>Kolumna ${i+1}: <input value="${c}" onchange="editColumn(${i},this.value)"></div>`;
  });
  s.innerHTML+=`<button onclick="addColumn()">➕ Dodaj kolumnę</button>`;
  s.innerHTML+=`<div><label><input type="checkbox" ${listSettings.withDate?"checked":""} onchange="toggleDate(this.checked)"> Data</label></div>`;
  s.innerHTML+=`<button onclick="deleteList()">🗑️ Usuń listę</button>`;
  s.innerHTML+=`<button onclick="resetList()">🔄 Resetuj listę</button>`;
}
function editColumn(i,v){
  listSettings.columns[i]=v;
  db.ref("lists/"+currentList+"/settings").set(listSettings);
  renderHead();renderForm();renderSettings();
}
function addColumn(){
  listSettings.columns.push("Nowa kolumna");
  db.ref("lists/"+currentList+"/settings").set(listSettings);
  renderHead();renderForm();renderSettings();
}
function toggleDate(ch){
  listSettings.withDate=ch;
  db.ref("lists/"+currentList+"/settings").set(listSettings);
  renderHead();renderForm();renderSettings();
}
function deleteList(){
  if(confirm("Usunąć listę "+currentList+"?")){
    db.ref("lists/"+currentList).remove();
    currentList=null;
    currentListTitle.innerText="Brak wybranej listy";
    entryForm.innerHTML="";tableHead.innerHTML="";tableBody.innerHTML="";
  }
}
function resetList(){
  if(confirm("Na pewno wyczyścić wszystkie wpisy z listy '"+currentList+"'?")){
    db.ref("lists/"+currentList+"/entries").remove();
  }
}

// --- Entries ---
function renderHead(){
  const h=document.getElementById("tableHead");h.innerHTML="";
  listSettings.columns.forEach(c=>h.innerHTML+="<th>"+c+"</th>");
  if(listSettings.withDate) h.innerHTML+="<th>Data</th>";
  h.innerHTML+="<th>Akcje</th>";
}
function renderForm(){
  const f=document.getElementById("entryForm");f.innerHTML="";
  listSettings.columns.forEach(c=>f.innerHTML+=`<input id="form-${c}" placeholder="${c}">`);
  if(listSettings.withDate) f.innerHTML+=`<input id="form-date" type="date">`;
  f.innerHTML+=`<button type="button" onclick="addEntry()">Dodaj</button>`;
}
function addEntry(){
  const e={};listSettings.columns.forEach(c=>e[c]=document.getElementById("form-"+c).value);
  if(listSettings.withDate) e.date=document.getElementById("form-date").value;
  db.ref("lists/"+currentList+"/entries").push(e);
}
function loadEntries(){
  db.ref("lists/"+currentList+"/entries").on("value",snap=>{
    const b=document.getElementById("tableBody");b.innerHTML="";
    snap.forEach(ch=>{
      const entryKey = ch.key;
      const e=ch.val();let tr=document.createElement("tr");

      listSettings.columns.forEach(c=>{
        let td=document.createElement("td");
        td.innerText = e[c] || "";
        if(currentUser.role==="admin"){
          td.style.cursor="pointer";
          td.onclick=()=>{
            const newVal = prompt("Edytuj wartość:", td.innerText);
            if(newVal!==null){
              db.ref("lists/"+currentList+"/entries/"+entryKey+"/"+c).set(newVal);
            }
          };
        }
        tr.appendChild(td);
      });

      if(listSettings.withDate){
        let td=document.createElement("td");
        td.innerText = e.date || "";
        if(currentUser.role==="admin"){
          td.style.cursor="pointer";
          td.onclick=()=>{
            const newVal = prompt("Edytuj datę:", td.innerText);
            if(newVal!==null){
              db.ref("lists/"+currentList+"/entries/"+entryKey+"/date").set(newVal);
            }
          };
        }
        tr.appendChild(td);
      }

      // akcje tylko dla admina
      let tdAct=document.createElement("td");
      if(currentUser.role==="admin"){
        let delBtn=document.createElement("button");
        delBtn.innerText="🗑️";
        delBtn.onclick=()=>db.ref("lists/"+currentList+"/entries/"+entryKey).remove();
        tdAct.appendChild(delBtn);
      }
      tr.appendChild(tdAct);

      b.appendChild(tr);
    });
  });
}

// --- Admin Panel ---
function loadUsers(){
  db.ref("users").on("value",snap=>{
    const uDiv=document.getElementById("users");uDiv.innerHTML="";
    snap.forEach(ch=>{
      const name=ch.key;const data=ch.val();
      const row=document.createElement("div");
      row.style.display="flex";row.style.justifyContent="space-between";row.style.margin="4px 0";
      row.innerHTML=`<span>${name} (${data.role})</span>`;
      const controls=document.createElement("div");
      const toggleBtn=document.createElement("button");
      toggleBtn.innerText="🔄 Rola";
      toggleBtn.onclick=()=>{
        const newRole=data.role==="admin"?"user":"admin";
        db.ref("users/"+name+"/role").set(newRole);
      };
      const delBtn=document.createElement("button");
      delBtn.innerText="🗑️";
      delBtn.onclick=()=>{
        if(confirm("Usunąć użytkownika "+name+"?")){
          db.ref("users/"+name).remove();
        }
      };
      controls.appendChild(toggleBtn);controls.appendChild(delBtn);
      row.appendChild(controls);
      uDiv.appendChild(row);
    });
  });
}

// --- Ensure admin exists ---
db.ref("users/admin").set({password:"1234",role:"admin"});
</script>
</body>
</html>